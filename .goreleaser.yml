before:
  hooks:
    # You may remove this if you don't use go modules.
    #- go mod download
    # you may remove this if you don't need go generate
    #- go generate ./...
    #- make validate
#
#
#  BUILDS
#
#
builds:
  - main: ./cmd/newrelic-infra
    id: newrelic-infra
    binary: newrelic-infra
    env:
    - CGO_ENABLED=0
    goos:
    - linux
    ldflags:
    - -s -w -X main.integrationVersion={{.Version}}
    goarch:
    - amd64
#    - arm
#    - arm64
#    - 386
#    - mips
#    - mips64
#    - mipsle
#    - mips64le
#    - ppc64le
#    - s390x
  - main: ./cmd/newrelic-infra-ctl
    id: newrelic-infra-ctl
    binary: newrelic-infra-ctl
    env:
    - CGO_ENABLED=0
    goos:
    - linux
    ldflags:
    - -s -w -X main.integrationVersion={{.Version}}
    goarch:
    - amd64
#    - arm
#    - arm64
#    - 386
#    - mips
#    - mips64
#    - mipsle
#    - mips64le
#    - ppc64le
#    - s390x
  - main: ./cmd/newrelic-infra-service
    id: newrelic-infra-service
    binary: newrelic-infra-service
    env:
    - CGO_ENABLED=0
    goos:
    - linux
    ldflags:
    - -s -w -X main.integrationVersion={{.Version}}
    goarch:
    - amd64
#    - arm
#    - arm64
#    - 386
#    - mips
#    - mips64
#    - mipsle
#    - mips64le
#    - ppc64le
#    - s390x
#
#
#  ARCHIVES
#
#
archives:
  - id: newrelic-infra_systemd
    builds:
      - newrelic-infra
      - newrelic-infra-ctl
      - newrelic-infra-service
    replacements:
      linux: Linux
      x86_64: amd64
    name_template: "newrelic-infra_systemd_{{ .Env.TAG }}_{{ .Arch }}"
    format: tar.gz
    files:
    - licence*
    - LICENCE*
    - license*
    - LICENSE*
    - readme*
    - README*
    - changelog*
    - CHANGELOG*
  - id: newrelic-infra_upstart
    builds:
      - newrelic-infra
      - newrelic-infra-ctl
      - newrelic-infra-service
    replacements:
      linux: Linux
      x86_64: amd64
    name_template: "newrelic-infra_upstart_{{ .Env.TAG }}_{{ .Arch }}"
    format: tar.gz
    files:
    - licence*
    - LICENCE*
    - license*
    - LICENSE*
    - readme*
    - README*
    - changelog*
    - CHANGELOG*
  - id: newrelic-infra_sysv
    builds:
      - newrelic-infra
      - newrelic-infra-ctl
      - newrelic-infra-service
    replacements:
      linux: Linux
      x86_64: amd64
    name_template: "newrelic-infra_sysv_{{ .Env.TAG }}_{{ .Arch }}"
    format: tar.gz
    files:
    - licence*
    - LICENCE*
    - license*
    - LICENSE*
    - readme*
    - README*
    - changelog*
    - CHANGELOG*

checksum:
  name_template: 'checksums.txt'
snapshot:
  name_template: "{{ .Tag }}-next"
changelog:
  filters:
    exclude:
    - '^docs:'
    - '^test:'
#
#
#  NFPMS
#
#
nfpms:
  - id: newrelic-infra_systemd
    builds:
      - newrelic-infra
      - newrelic-infra-ctl
      - newrelic-infra-service
    file_name_template: "newrelic-infra_systemd_{{ .Env.TAG }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}"
    vendor: "New Relic, Inc."
    homepage: "https://docs.newrelic.com/docs/release-notes/infrastructure-release-notes/infrastructure-agent-release-notes/new-relic-infrastructure-agent-197"
    maintainer: "caos-team@newrelic.com"
    description: "New Relic Infrastructure provides flexible, dynamic server monitoring. With real-time data collection and a UI that scales from a handful of hosts to thousands, Infrastructure is designed for modern Operations teams with fast-changing systems."
    license: "Copyright (c) 2008-2020 New Relic, Inc. All rights reserved."
    # Formats to be generated.
    formats:
      - deb
      - rpm
    # Override default /usr/local/bin destination for binaries
    bindir: ./usr/bin
    files:
       "build/package/systemd/newrelic-infra.service": "./etc/systemd/system/newrelic-infra.service"
       "binaries/nri-docker/etc/newrelic-infra/integrations.d/docker-config.yml": "/etc/newrelic-infra/integrations.d/docker-config.yml"
       "binaries/nri-docker/var/db/newrelic-infra/newrelic-integrations/bin/nri-docker": "./var/db/newrelic-infra/newrelic-integrations/bin/nri-docker"
    empty_folders:
      - /var/db/newrelic-infra/custom-integrations
      - /var/db/newrelic-infra/integrations.d
      - /var/log/newrelic-infra
      - /var/run/newrelic-infra
    overrides:
      rpm:
        replacements:
          amd64: x86_64 # Exceptions in the name, .deb are amd64, .rpm are x86_64

###################################################
  - id: newrelic-infra_upstart
    builds:
      - newrelic-infra
      - newrelic-infra-ctl
      - newrelic-infra-service
    file_name_template: "newrelic-infra_systemd_{{ .Env.TAG }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}"
    vendor: "New Relic, Inc."
    homepage: "https://docs.newrelic.com/docs/release-notes/infrastructure-release-notes/infrastructure-agent-release-notes/new-relic-infrastructure-agent-197"
    maintainer: "caos-team@newrelic.com"
    description: "New Relic Infrastructure provides flexible, dynamic server monitoring. With real-time data collection and a UI that scales from a handful of hosts to thousands, Infrastructure is designed for modern Operations teams with fast-changing systems."
    license: "Copyright (c) 2008-2020 New Relic, Inc. All rights reserved."
    # Formats to be generated.
    formats:
      - deb
      - rpm
    # Override default /usr/local/bin destination for binaries
    bindir: ./usr/bin
    files:
       "build/package/sysv/deb/newrelic-infra": "./etc/init/newrelic-infra.conf"
       "binaries/nri-docker/etc/newrelic-infra/integrations.d/docker-config.yml": "./etc/newrelic-infra/integrations.d/docker-config.yml"
       "build/package/upstart/newrelic-infra": "./etc/init.d/newrelic-infra"
       "binaries/nri-docker/var/db/newrelic-infra/newrelic-integrations/bin/nri-docker": "./var/db/newrelic-infra/newrelic-integrations/bin/nri-docker"
    empty_folders:
      - /var/db/newrelic-infra/custom-integrations
      - /var/db/newrelic-infra/integrations.d
      - /var/log/newrelic-infra
      - /var/run/newrelic-infra
    overrides:
      rpm:
        replacements:
          amd64: x86_64 # Exceptions in the name, .deb are amd64, .rpm are x86_64
###################################################
  - id: newrelic-infra_sysv
    builds:
      - newrelic-infra
      - newrelic-infra-ctl
      - newrelic-infra-service
    file_name_template: "newrelic-infra_systemd_{{ .Env.TAG }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}"
    vendor: "New Relic, Inc."
    homepage: "https://docs.newrelic.com/docs/release-notes/infrastructure-release-notes/infrastructure-agent-release-notes/new-relic-infrastructure-agent-197"
    maintainer: "caos-team@newrelic.com"
    description: "New Relic Infrastructure provides flexible, dynamic server monitoring. With real-time data collection and a UI that scales from a handful of hosts to thousands, Infrastructure is designed for modern Operations teams with fast-changing systems."
    license: "Copyright (c) 2008-2020 New Relic, Inc. All rights reserved."
    # Formats to be generated.
    formats:
      - deb
      - rpm
    # Override default /usr/local/bin destination for binaries
    bindir: ./usr/bin
    files:
       "binaries/nri-docker/etc/newrelic-infra/integrations.d/docker-config.yml": "./etc/newrelic-infra/integrations.d/docker-config.yml"
       "build/package/upstart/newrelic-infra": "./etc/init.d/newrelic-infra"
       "binaries/nri-docker/var/db/newrelic-infra/newrelic-integrations/bin/nri-docker": "./var/db/newrelic-infra/newrelic-integrations/bin/nri-docker"
    empty_folders:
      - /var/db/newrelic-infra/custom-integrations
      - /var/db/newrelic-infra/integrations.d
      - /var/log/newrelic-infra
      - /var/run/newrelic-infra
    overrides:
      rpm:
        replacements:
          amd64: x86_64 # Exceptions in the name, .deb are amd64, .rpm are x86_64


release:
  prerelease: true

signs:
  - artifacts: checksum
    cmd: gpg2
    args: ["--batch", "-u", "{{ .Env.GPG_MAIL }}", "--passphrase", "{{ .Env.GPG_PASSPHRASE }}", "--pinentry-mode", "loopback", "--output", "${signature}", "--detach-sign", "${artifact}"]

